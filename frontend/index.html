<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      rel="preload"
      href="/fonts/newsreader/newsreader-roman.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/jetbrains-mono/jetbrainsmono-roman.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f1e6" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0d10" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      ;(() => {
        try {
          const stored = localStorage.getItem('bm-theme')
          if (stored === 'dark' || stored === 'light') {
            document.documentElement.dataset.theme = stored
          } else {
            document.documentElement.removeAttribute('data-theme')
          }
        } catch {
          // ignore
        }
      })()
    </script>
    <script>
      ;(() => {
        const store = (window.__bm_prefetch ??= {})
        const prefetchJson = (path) => {
          if (store[path]) return
          store[path] = fetch(path, {
            method: 'GET',
            headers: { Accept: 'application/json' },
          })
            .then(async (res) => {
              let payload
              try {
                payload = await res.json()
              } catch {
                payload = undefined
              }
              return { ok: res.ok, status: res.status, payload }
            })
            .catch(() => ({ ok: false, status: 0, payload: undefined }))
        }

        // Start core API requests while the JS bundle is still downloading.
        prefetchJson('/api/v1/info')

        const parts = window.location.pathname.split('/').filter(Boolean)
        if (parts[0] === 'man' && parts.length >= 3) {
          const rawName = parts[1] ?? ''
          const rawSection = parts[2] ?? ''
          let name = rawName
          let section = rawSection
          try {
            name = decodeURIComponent(rawName)
          } catch {
            // ignore
          }
          try {
            section = decodeURIComponent(rawSection)
          } catch {
            // ignore
          }
          prefetchJson(`/api/v1/man/${encodeURIComponent(name)}/${encodeURIComponent(section)}`)
        } else if (parts[0] === 'man' && parts.length === 2) {
          const rawName = parts[1] ?? ''
          let name = rawName
          try {
            name = decodeURIComponent(rawName)
          } catch {
            // ignore
          }
          prefetchJson(`/api/v1/man/${encodeURIComponent(name)}`)
        } else if (parts[0] === 'search') {
          const params = new URLSearchParams(window.location.search)
          const q = params.get('q')?.trim() ?? ''
          const section = params.get('section')?.trim() ?? ''

          if (q) {
            const apiParams = new URLSearchParams()
            apiParams.set('q', q)
            if (section) apiParams.set('section', section)
            apiParams.set('limit', '20')
            apiParams.set('offset', '0')
            prefetchJson(`/api/v1/search?${apiParams.toString()}`)
          }

          prefetchJson('/api/v1/sections')
        }
      })()
    </script>
    <title>BetterMan</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
