name: Parse Man Pages

on:
  workflow_dispatch:
  schedule:
    # Run monthly to keep man pages updated
    - cron: '0 0 1 * *'
  push:
    paths:
      - 'scripts/parse-man-pages-ci.ts'
      - '.github/workflows/parse-man-pages.yml'

jobs:
  parse-man-pages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Essential Ubuntu Packages
        run: |
          # Update package list
          sudo apt-get update
          
          # Install core man pages in one go
          sudo apt-get install -y \
            man-db manpages manpages-dev manpages-posix manpages-posix-dev || true
          
          # Install essential tools that provide important man pages
          sudo apt-get install -y --no-install-recommends \
            bash-doc coreutils util-linux procps iproute2 net-tools \
            iputils-ping dnsutils curl wget git vim nano tmux screen \
            openssh-client rsync gzip bzip2 xz-utils tar zip unzip \
            findutils grep sed gawk diffutils patch less make gcc \
            python3 jq htop tree lsof strace tcpdump \
            postgresql-client mysql-client redis-tools \
            nginx apache2-utils ncdu nmap || true
          
          # Update man database
          sudo mandb
          
      - name: Install Node.js Dependencies
        run: |
          npm ci
          npm install -g tsx
      
      - name: Parse Man Pages
        id: parse
        run: |
          # Create output directory
          mkdir -p data/parsed-man-pages-linux
          
          # Run the parsing script
          tsx scripts/parse-man-pages-ci.ts
        env:
          CI: true
      
      - name: Migrate to Application Format
        if: success()
        run: |
          # Run the migration script
          tsx scripts/migrate-linux-man-pages.ts
          
          # Create backup for reference
          cp -r data/parsed-man-pages-linux data/parsed-man-pages-linux-backup || true
      
      - name: Generate Summary Report
        if: always()
        run: |
          # Generate summary report
          echo "# Man Page Parse Report" > MAN_PAGES_REPORT.md
          echo "" >> MAN_PAGES_REPORT.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> MAN_PAGES_REPORT.md
          echo "**Environment:** Ubuntu $(lsb_release -rs)" >> MAN_PAGES_REPORT.md
          echo "" >> MAN_PAGES_REPORT.md
          
          # Parse stats from manifest if available
          if [ -f data/parsed-man-pages-linux/manifest.json ]; then
            total=$(jq -r '.totalPages' data/parsed-man-pages-linux/manifest.json)
            echo "## Parse Statistics" >> MAN_PAGES_REPORT.md
            echo "- **Total Pages Parsed:** $total" >> MAN_PAGES_REPORT.md
            echo "" >> MAN_PAGES_REPORT.md
            
            echo "### By Section" >> MAN_PAGES_REPORT.md
            jq -r '.stats.bySection | to_entries | sort_by(.key | tonumber) | .[] | "- Section \(.key): \(.value) pages"' data/parsed-man-pages-linux/manifest.json >> MAN_PAGES_REPORT.md
            echo "" >> MAN_PAGES_REPORT.md
            
            echo "### Top Categories" >> MAN_PAGES_REPORT.md
            jq -r '.stats.byCategory | to_entries | sort_by(.value) | reverse | .[0:10] | .[] | "- \(.key): \(.value) pages"' data/parsed-man-pages-linux/manifest.json >> MAN_PAGES_REPORT.md
          else
            # Fallback to file count
            count=$(find data/parsed-man-pages-linux/json -name "*.json" 2>/dev/null | wc -l || echo "0")
            echo "## Parse Results" >> MAN_PAGES_REPORT.md
            echo "- **JSON Files Created:** $count" >> MAN_PAGES_REPORT.md
          fi
          
          echo "" >> MAN_PAGES_REPORT.md
          echo "## Quality Improvements" >> MAN_PAGES_REPORT.md
          echo "- ✅ Full GNU documentation with comprehensive examples" >> MAN_PAGES_REPORT.md
          echo "- ✅ Detailed option descriptions and usage scenarios" >> MAN_PAGES_REPORT.md
          echo "- ✅ Better formatting and structure" >> MAN_PAGES_REPORT.md
          echo "- ✅ More cross-references and related commands" >> MAN_PAGES_REPORT.md
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: man-pages-linux
          path: |
            data/parsed-man-pages-linux/
            data/man-pages/
            MAN_PAGES_REPORT.md
          retention-days: 30
      
      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update man pages from Ubuntu Linux"
          title: "🚀 Update Man Pages (Linux)"
          body: |
            ## 📚 Man Page Update
            
            This PR updates the man pages parsed from Ubuntu Linux.
            
            ### 📊 Parse Results
            See attached `MAN_PAGES_REPORT.md` for detailed statistics.
            
            ### ✨ Highlights
            - Parsed comprehensive man pages from Ubuntu's documentation
            - Updated with latest GNU/Linux documentation
            - Includes full examples, detailed options, and comprehensive descriptions
            - Significantly improved quality over macOS man pages
            
            ### 🔍 Review Checklist
            - [ ] Verify man page count is reasonable (>10,000 pages)
            - [ ] Check that migration completed successfully
            - [ ] Review sample pages for quality
            
            ---
            *This PR was automatically generated by the parse-man-pages workflow.*
          branch: update-man-pages-linux
          delete-branch: true
          labels: |
            documentation
            automated
            man-pages