name: deploy-railway

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, SHA) to deploy"
        required: false
        default: main

concurrency:
  group: deploy-railway-${{ inputs.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    env:
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_WORKSPACE_ID: ed8a9f0d-ab1b-48a4-a7a1-86a95b0e5f18
      RAILWAY_PROJECT_ID: efecaef3-7389-4b3e-b767-5f56858b845e
      RAILWAY_ENVIRONMENT_ID: dc10158e-d1fd-4039-9089-4c6068357251
      RAILWAY_SERVICE_ID: d254e49e-352c-4678-8933-eab6422a02c1
      RAILWAY_NEXTJS_SERVICE_ID: 40fa322d-c334-4662-8858-8edf380d3f10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          ref: ${{ inputs.ref }}

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25

      - name: Install Railway CLI
        shell: bash
        run: |
          set -euo pipefail

          export RAILWAY_VERSION="4.18.1"

          mkdir -p "$HOME/.local/bin"
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          for attempt in 1 2 3; do
            echo "Installing Railway CLI v${RAILWAY_VERSION} (attempt $attempt/3)…"
            if curl -fsSL https://railway.app/install.sh | bash -s -- -y -b "$HOME/.local/bin"; then
              break
            fi
            sleep $((attempt * 10))
          done

          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway install.sh failed; falling back to npm @railway/cli@4.17.1" >&2
            npm install -g @railway/cli@4.17.1
          fi

          railway --version

      - name: Deploy services
        shell: bash
        run: |
          set -euo pipefail

          deploy_service() {
            local service_id="$1"

            railway link \
              --workspace "$RAILWAY_WORKSPACE_ID" \
              --project "$RAILWAY_PROJECT_ID" \
              --environment "$RAILWAY_ENVIRONMENT_ID" \
              --service "$service_id"

            railway up --ci \
              --service "$service_id" \
              --environment "$RAILWAY_ENVIRONMENT_ID"

            echo "Waiting for Railway deployment to reach SUCCESS (serviceId=${service_id})…"
            for attempt in {1..60}; do
              info="$(railway service status --json --service "$service_id" --environment "$RAILWAY_ENVIRONMENT_ID")"
              status="$(echo "$info" | jq -r '.status // empty')"
              stopped="$(echo "$info" | jq -r '.stopped')"
              deployment_id="$(echo "$info" | jq -r '.deploymentId // empty')"

              echo "[$attempt/60] status=${status} stopped=${stopped} deploymentId=${deployment_id}"

              if [[ "$status" == "SUCCESS" && "$stopped" == "false" ]]; then
                return 0
              fi

              if [[ "$status" == "FAILURE" || "$status" == "ERROR" || "$status" == "CRASHED" ]]; then
                echo "Railway deployment failed"
                return 1
              fi

              sleep 5
            done

            echo "Timed out waiting for Railway deployment"
            return 1
          }

          deploy_service "$RAILWAY_SERVICE_ID"
          deploy_service "$RAILWAY_NEXTJS_SERVICE_ID"
