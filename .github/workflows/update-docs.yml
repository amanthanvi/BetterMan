name: update-dataset

on:
  workflow_dispatch:
    inputs:
      ingest:
        description: Run ingestion into staging DB
        type: boolean
        required: false
        default: true
      promote:
        description: Promote active staging releases to prod
        type: boolean
        required: false
        default: false
  schedule:
    # Monthly on the 1st at 05:00 UTC
    - cron: "0 5 1 * *"

concurrency:
  group: update-dataset
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  ingest_linux:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.ingest != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pipx install uv
      - run: cd ingestion && uv sync --frozen

      - name: Ingest to staging DB
        env:
          INGEST_DATABASE_URL: ${{ secrets.BETTERMAN_STAGING_DATABASE_URL }}
          BETTERMAN_DEBIAN_IMAGE_REF: debian:trixie
          BETTERMAN_UBUNTU_IMAGE_REF: ubuntu:24.04
          BETTERMAN_FEDORA_IMAGE_REF: fedora:41
          BETTERMAN_ARCH_IMAGE_REF: archlinux:latest
          BETTERMAN_ALPINE_IMAGE_REF: alpine:3.20
        shell: bash
        run: |
          set -euo pipefail

          cd ingestion

          echo "Ingesting Debian…"
          uv run python -m ingestion.cli ingest --distro debian --activate

          echo "Ingesting Arch…"
          uv run python -m ingestion.cli ingest --distro arch --activate

          echo "Ingesting Alpine…"
          uv run python -m ingestion.cli ingest --distro alpine --activate

          echo "Ingesting Ubuntu…"
          uv run python -m ingestion.cli ingest --distro ubuntu --activate || echo "Ubuntu ingest failed (continuing)"

          echo "Ingesting Fedora…"
          uv run python -m ingestion.cli ingest --distro fedora --activate || echo "Fedora ingest failed (continuing)"

  ingest_macos:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.ingest != 'false' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pipx install uv
      - run: cd ingestion && uv sync --frozen

      - name: Ingest macOS (BSD) to staging DB
        env:
          INGEST_DATABASE_URL: ${{ secrets.BETTERMAN_STAGING_DATABASE_URL }}
        shell: bash
        run: |
          set -euo pipefail

          cd ingestion

          echo "Ingesting macOS (BSD)…"
          uv run python -m ingestion.cli ingest --distro macos --activate

  ingest_freebsd:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.ingest != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Ingest FreeBSD to staging DB
        uses: vmactions/freebsd-vm@f674f993e17ee7a71c14726b5d96599e59cda724 # v1
        with:
          release: "15.0"
          envs: "INGEST_DATABASE_URL BETTERMAN_INGEST_GIT_SHA"
          usesh: true
          run: |
            set -euo pipefail

            cd "$GITHUB_WORKSPACE"

            pkg update -f
            pkg install -y python3

            py="python3"
            if ! $py -c 'import sys; raise SystemExit(0 if sys.version_info >= (3, 12) else 1)'; then
              echo "python3 is < 3.12; installing python312…"
              pkg install -y python312
              py="python3.12"
            fi

            if ! command -v cargo >/dev/null 2>&1; then
              echo "cargo not found; installing Rust toolchain (required to build pydantic-core)…"
              pkg install -y rust
            fi

            $py -m ensurepip --upgrade
            $py -m pip install --upgrade pip
            $py -m pip install ./ingestion

            echo "Ingesting FreeBSD…"
            $py -m ingestion.cli ingest --distro freebsd --activate
        env:
          INGEST_DATABASE_URL: ${{ secrets.BETTERMAN_STAGING_DATABASE_URL }}
          BETTERMAN_INGEST_GIT_SHA: ${{ github.sha }}

  promote:
    runs-on: ubuntu-latest
    needs: [ingest_linux, ingest_macos, ingest_freebsd]
    if: ${{ always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.promote == 'true') }}
    steps:
      - name: Install Postgres client (pg_dump/psql)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Promote active dataset from staging to prod
        env:
          STAGING_DB_URL: ${{ secrets.BETTERMAN_STAGING_DATABASE_URL }}
          PROD_DB_URL: ${{ secrets.BETTERMAN_PROD_DATABASE_URL }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${STAGING_DB_URL:-}" || -z "${PROD_DB_URL:-}" ]]; then
            echo "Missing BETTERMAN_STAGING_DATABASE_URL / BETTERMAN_PROD_DATABASE_URL secrets."
            exit 1
          fi

          dump_flags=(--data-only --no-owner --no-privileges --column-inserts)

          for distro in debian ubuntu fedora arch alpine freebsd macos; do
            row="$(psql "$STAGING_DB_URL" -t -A -c "SELECT id, dataset_release_id FROM dataset_releases WHERE locale = 'en' AND distro = '${distro}' AND is_active = TRUE ORDER BY ingested_at DESC LIMIT 1;")"
            if [[ -z "$row" ]]; then
              echo "No active ${distro} dataset release found in staging; skipping."
              continue
            fi

            release_uuid="${row%%|*}"
            release_id="${row#*|}"
            echo "Staging active ${distro} release: $release_uuid ($release_id)"

            exists="$(psql "$PROD_DB_URL" -t -A -c "SELECT COUNT(*) FROM dataset_releases WHERE dataset_release_id = '$release_id';")"
            if [[ "${exists:-0}" != "0" ]]; then
              echo "Release already present in prod; ensuring it is active for ${distro}."
              psql "$PROD_DB_URL" -v ON_ERROR_STOP=1 -c "UPDATE dataset_releases SET is_active = FALSE WHERE locale = 'en' AND distro = '${distro}' AND is_active = TRUE; UPDATE dataset_releases SET is_active = TRUE WHERE id = '$release_uuid'::uuid;"
              continue
            fi

            {
              echo "BEGIN;"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=dataset_releases \
                --where="id = '$release_uuid'::uuid"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=licenses \
                --where="id IN (SELECT license_id FROM man_page_license_map WHERE man_page_id IN (SELECT id FROM man_pages WHERE dataset_release_id = '$release_uuid'::uuid))"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=man_pages \
                --where="dataset_release_id = '$release_uuid'::uuid"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=man_page_content \
                --where="man_page_id IN (SELECT id FROM man_pages WHERE dataset_release_id = '$release_uuid'::uuid)"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=man_page_search \
                --where="man_page_id IN (SELECT id FROM man_pages WHERE dataset_release_id = '$release_uuid'::uuid)"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=man_page_links \
                --where="from_page_id IN (SELECT id FROM man_pages WHERE dataset_release_id = '$release_uuid'::uuid)"

              pg_dump "$STAGING_DB_URL" "${dump_flags[@]}" \
                --table=man_page_license_map \
                --where="man_page_id IN (SELECT id FROM man_pages WHERE dataset_release_id = '$release_uuid'::uuid)"

              echo "COMMIT;"
            } > promote.sql

            psql "$PROD_DB_URL" -v ON_ERROR_STOP=1 -f promote.sql

            psql "$PROD_DB_URL" -v ON_ERROR_STOP=1 -c "UPDATE dataset_releases SET is_active = FALSE WHERE locale = 'en' AND distro = '${distro}' AND is_active = TRUE; UPDATE dataset_releases SET is_active = TRUE WHERE id = '$release_uuid'::uuid;"
          done
