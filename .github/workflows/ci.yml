name: ci

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  dependency_review:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Dependency review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4
        with:
          fail-on-severity: high

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm -C frontend lint
      - run: pnpm -C frontend test
      - run: pnpm -C frontend build
      - run: pnpm -C frontend bundle:report

  nextjs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm -C nextjs lint
      - run: pnpm -C nextjs build

  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pipx install uv
      - run: cd backend && uv sync --frozen
      - run: cd backend && uv run ruff check .
      - run: cd backend && uv run ruff format --check .
      - run: cd backend && uv run pytest

  ingestion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pipx install uv
      - run: cd ingestion && uv sync --frozen
      - run: cd ingestion && uv run ruff check .
      - run: cd ingestion && uv run ruff format --check .
      - run: cd ingestion && uv run python -m pytest

  api_types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25
          cache: pnpm

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pnpm install --frozen-lockfile

      - run: pipx install uv
      - run: cd backend && uv sync --frozen

      - name: OpenAPI types are up to date
        run: |
          set -euo pipefail

          cd backend
          uv run python scripts/export_openapi.py /tmp/betterman-openapi.json

          cd ..
          pnpm -C frontend exec openapi-typescript /tmp/betterman-openapi.json --output src/api/openapi.gen.ts

          git diff --exit-code frontend/src/api/openapi.gen.ts

  e2e:
    needs:
      - frontend
      - nextjs
      - backend
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: betterman
          POSTGRES_PASSWORD: betterman
          POSTGRES_DB: betterman
        ports:
          - 54320:5432
        options: >-
          --health-cmd="pg_isready -U betterman -d betterman"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10.27.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25
          cache: pnpm

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: 3.14

      - run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm -C frontend exec playwright install --with-deps chromium

      - run: pipx install uv
      - run: cd backend && uv sync --frozen

      - name: Migrate + seed DB
        env:
          BETTERMAN_E2E_SEED: "1"
        run: |
          set -euo pipefail
          cd backend
          uv run python -m app.db.migrate
          uv run python scripts/seed_e2e.py

      - name: Start backend (serves SPA + API)
        run: |
          set -euo pipefail

          cd backend
          nohup uv run uvicorn app.main:app --host 127.0.0.1 --port 8000 > /tmp/betterman-e2e.log 2>&1 &

          for attempt in {1..60}; do
            if curl -fsS http://127.0.0.1:8000/healthz >/dev/null; then
              exit 0
            fi
            sleep 1
          done

          echo "Timed out waiting for backend"
          tail -n 200 /tmp/betterman-e2e.log || true
          exit 1

      - name: Start Next.js
        env:
          FASTAPI_INTERNAL_URL: http://127.0.0.1:8000
        run: |
          set -euo pipefail

          pnpm -C nextjs build

          nohup pnpm -C nextjs exec next start -p 3000 > /tmp/betterman-next.log 2>&1 &

          for attempt in {1..60}; do
            if curl -fsS http://127.0.0.1:3000/robots.txt >/dev/null; then
              exit 0
            fi
            sleep 1
          done

          echo "Timed out waiting for Next.js"
          tail -n 200 /tmp/betterman-next.log || true
          exit 1

      - name: Run Playwright E2E + a11y
        env:
          E2E_BASE_URL: http://127.0.0.1:3000
        run: pnpm -C frontend e2e

  deploy_railway:
    needs:
      - frontend
      - nextjs
      - backend
      - ingestion
      - api_types
      - e2e
    if: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 25

      - name: Install Railway CLI
        shell: bash
        run: |
          set -euo pipefail

          export RAILWAY_VERSION="4.18.1"

          mkdir -p "$HOME/.local/bin"
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          for attempt in 1 2 3; do
            echo "Installing Railway CLI v${RAILWAY_VERSION} (attempt $attempt/3)…"
            if curl -fsSL https://railway.app/install.sh | bash -s -- -y -b "$HOME/.local/bin"; then
              break
            fi
            sleep $((attempt * 10))
          done

          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway install.sh failed; falling back to npm @railway/cli@4.17.1" >&2
            npm install -g @railway/cli@4.17.1
          fi

          railway --version

      - name: Deploy web (Railway)
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_WORKSPACE_ID: ed8a9f0d-ab1b-48a4-a7a1-86a95b0e5f18
          RAILWAY_PROJECT_ID: efecaef3-7389-4b3e-b767-5f56858b845e
          RAILWAY_ENVIRONMENT_ID: dc10158e-d1fd-4039-9089-4c6068357251
          RAILWAY_SERVICE_ID: d254e49e-352c-4678-8933-eab6422a02c1
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${RAILWAY_API_TOKEN:-}" ]]; then
            echo "Missing RAILWAY_TOKEN GitHub Actions secret."
            exit 1
          fi

          railway link \
            --workspace "$RAILWAY_WORKSPACE_ID" \
            --project "$RAILWAY_PROJECT_ID" \
            --environment "$RAILWAY_ENVIRONMENT_ID" \
            --service "$RAILWAY_SERVICE_ID"

          railway up --ci \
            --service "$RAILWAY_SERVICE_ID" \
            --environment "$RAILWAY_ENVIRONMENT_ID"

          echo "Waiting for Railway deployment to reach SUCCESS…"
          for attempt in {1..60}; do
            info="$(railway service status --json --service "$RAILWAY_SERVICE_ID" --environment "$RAILWAY_ENVIRONMENT_ID")"
            status="$(echo "$info" | jq -r '.status // empty')"
            stopped="$(echo "$info" | jq -r '.stopped')"
            deployment_id="$(echo "$info" | jq -r '.deploymentId // empty')"

            echo "[$attempt/60] status=${status} stopped=${stopped} deploymentId=${deployment_id}"

            if [[ "$status" == "SUCCESS" && "$stopped" == "false" ]]; then
              exit 0
            fi

            if [[ "$status" == "FAILURE" || "$status" == "ERROR" ]]; then
              echo "Railway deployment failed"
              exit 1
            fi

            sleep 5
          done

          echo "Timed out waiting for Railway deployment"
          exit 1
